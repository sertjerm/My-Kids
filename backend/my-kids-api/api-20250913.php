<?php
// api.php - MyKids API with Complete Database Integration

// ‡∏õ‡∏¥‡∏î error ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ production)
error_reporting(E_ALL);
ini_set('display_errors', 0);
ini_set('log_errors', 1);

// ‡∏•‡πâ‡∏≤‡∏á output buffer
while (ob_get_level()) ob_end_clean();

// Headers - CORS
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, Accept, X-Requested-With');

// Handle preflight OPTIONS requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

// Helper function to calculate points from behavior or reward
function calculateEarnedPoints($pdo, $itemId, $activityType, $count) {
    try {
        $earnedPoints = 0;
        
        if ($activityType === 'Good' || $activityType === 'Bad') {
            // ‡∏´‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Behaviors table
            $stmt = $pdo->prepare("SELECT Points FROM Behaviors WHERE Id = ? AND IsActive = 1");
            $stmt->execute([$itemId]);
            $behavior = $stmt->fetch();
            
            if ($behavior) {
                $earnedPoints = $behavior['Points'] * $count;
            }
        } else if ($activityType === 'Reward') {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏ö (‡∏ï‡∏±‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
            $stmt = $pdo->prepare("SELECT Cost FROM Rewards WHERE Id = ? AND IsActive = 1");
            $stmt->execute([$itemId]);
            $reward = $stmt->fetch();
            
            if ($reward) {
                $earnedPoints = -($reward['Cost'] * $count); // ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            }
        }
        
        return $earnedPoints;
    } catch (Exception $e) {
        error_log("Error calculating points: " . $e->getMessage());
        return 0;
    }
}

try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö endpoint
    $endpoint = '';
    if (!empty($_GET)) {
        $keys = array_keys($_GET);
        $endpoint = $keys[0] ?? '';
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
    $pdo = null;
    $dbConnection = false;
    $dbError = '';
    
    if (file_exists('config.php')) {
        try {
            require_once 'config.php';
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ constants ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (defined('DB_HOST') && defined('DB_NAME') && defined('DB_USER') && defined('DB_PASS')) {
                // ‡πÉ‡∏ä‡πâ PDO ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á
                $dsn = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4";
                $pdo = new PDO($dsn, DB_USER, DB_PASS, [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false
                ]);
                $dbConnection = true;
            } elseif (function_exists('getDbConnection')) {
                // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getDbConnection
                $pdo = getDbConnection();
                $dbConnection = true;
            } else {
                $dbError = 'Config loaded but no DB constants or function found';
            }
        } catch (Exception $e) {
            $dbError = $e->getMessage();
            error_log("DB Connection Error: " . $e->getMessage());
        }
    } else {
        $dbError = 'config.php not found';
    }

    // Response ‡∏ï‡∏≤‡∏° endpoint
    switch ($endpoint) {
        case 'health':
            $childrenCount = 0;
            $dbStatus = 'disconnected';
            
            if ($dbConnection && $pdo) {
                try {
                    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö connection ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö children
                    $stmt = $pdo->query("SELECT COUNT(*) as count FROM Children WHERE IsActive = 1");
                    $result = $stmt->fetch();
                    $childrenCount = (int)$result['count'];
                    $dbStatus = 'connected';
                } catch (Exception $e) {
                    $dbStatus = 'error: ' . $e->getMessage();
                    error_log("Health Check DB Error: " . $e->getMessage());
                }
            }
            
            echo json_encode([
                'status' => 'OK',
                'message' => 'MyKids API is working!',
                'version' => '3.2.0-complete-database',
                'timestamp' => date('c'),
                'config_exists' => file_exists('config.php'),
                'db_connection' => $dbConnection,
                'db_status' => $dbStatus,
                'db_error' => $dbError,
                'children_count' => $childrenCount,
                'php_version' => PHP_VERSION,
                'server' => $_SERVER['HTTP_HOST'],
                'constants_check' => [
                    'DB_HOST' => defined('DB_HOST') ? 'defined' : 'missing',
                    'DB_NAME' => defined('DB_NAME') ? 'defined' : 'missing',
                    'DB_USER' => defined('DB_USER') ? 'defined' : 'missing',
                    'DB_PASS' => defined('DB_PASS') ? 'defined' : 'missing'
                ]
            ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            break;
            
        case 'children':
            if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà
                $input = json_decode(file_get_contents('php://input'), true);
                
                if (!$input || empty($input['Name'])) {
                    http_response_code(400);
                    echo json_encode(['error' => 'Missing Name field'], JSON_UNESCAPED_UNICODE);
                    exit();
                }
                
                if ($dbConnection && $pdo) {
                    try {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
                        $stmt = $pdo->query("SELECT MAX(CAST(SUBSTRING(Id, 2) AS UNSIGNED)) as max_num FROM Children");
                        $result = $stmt->fetch();
                        $nextNumber = ($result['max_num'] ?? 0) + 1;
                        $newId = 'C' . str_pad($nextNumber, 3, '0', STR_PAD_LEFT);
                        
                        // Insert
                        $stmt = $pdo->prepare("INSERT INTO Children (Id, Name, Age, AvatarPath, IsActive, CreatedAt) VALUES (?, ?, ?, ?, 1, NOW())");
                        $result = $stmt->execute([
                            $newId,
                            trim($input['Name']),
                            !empty($input['Age']) ? (int)$input['Age'] : null,
                            !empty($input['AvatarPath']) ? $input['AvatarPath'] : 'üë∂'
                        ]);
                        
                        if ($result) {
                            echo json_encode([
                                'success' => true,
                                'message' => 'Child created successfully',
                                'id' => $newId,
                                'data' => [
                                    'Id' => $newId,
                                    'Name' => trim($input['Name']),
                                    'Age' => !empty($input['Age']) ? (int)$input['Age'] : null,
                                    'AvatarPath' => !empty($input['AvatarPath']) ? $input['AvatarPath'] : 'üë∂',
                                    'IsActive' => 1,
                                    'CreatedAt' => date('Y-m-d H:i:s')
                                ]
                            ], JSON_UNESCAPED_UNICODE);
                        } else {
                            http_response_code(500);
                            echo json_encode(['error' => 'Database insert failed'], JSON_UNESCAPED_UNICODE);
                        }
                    } catch (Exception $e) {
                        error_log("Create Child Error: " . $e->getMessage());
                        http_response_code(500);
                        echo json_encode(['error' => 'Database error: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                    }
                } else {
                    http_response_code(503);
                    echo json_encode([
                        'error' => 'Database not connected',
                        'db_error' => $dbError
                    ], JSON_UNESCAPED_UNICODE);
                }
            } else {
                // GET children - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å database ‡∏à‡∏£‡∏¥‡∏á
                if ($dbConnection && $pdo) {
                    try {
                        $stmt = $pdo->query("SELECT * FROM Children WHERE IsActive = 1 ORDER BY Name");
                        $children = $stmt->fetchAll();
                        echo json_encode($children, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                    } catch (Exception $e) {
                        error_log("Get Children Error: " . $e->getMessage());
                        http_response_code(500);
                        echo json_encode(['error' => 'Database query failed: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                    }
                } else {
                    // Mock data ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ DB ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ)
                    echo json_encode([
                        ['Id' => 'C001', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö1', 'Age' => 8, 'AvatarPath' => 'üë∂', 'IsActive' => 1],
                        ['Id' => 'C002', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö2', 'Age' => 9, 'AvatarPath' => 'üßí', 'IsActive' => 1]
                    ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                }
            }
            break;
            
        case 'behaviors':
            // ‡∏™‡πà‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å database
            if ($dbConnection && $pdo) {
                try {
                    $stmt = $pdo->query("SELECT * FROM Behaviors WHERE IsActive = 1 ORDER BY Type, Name");
                    $behaviors = $stmt->fetchAll();
                    echo json_encode($behaviors, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                } catch (Exception $e) {
                    error_log("Get Behaviors Error: " . $e->getMessage());
                    http_response_code(500);
                    echo json_encode(['error' => 'Database query failed: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                }
            } else {
                // Mock data
                echo json_encode([
                    ['Id' => 'B001', 'Name' => '‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô', 'Points' => 10, 'Type' => 'Good', 'IsActive' => 1],
                    ['Id' => 'B002', 'Name' => '‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', 'Points' => 5, 'Type' => 'Good', 'IsActive' => 1],
                    ['Id' => 'B003', 'Name' => '‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏Å‡∏±‡∏ô', 'Points' => -5, 'Type' => 'Bad', 'IsActive' => 1]
                ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            }
            break;
            
        case 'good-behaviors':
        case 'tasks':
            // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡∏µ‡∏à‡∏≤‡∏Å database
            if ($dbConnection && $pdo) {
                try {
                    $stmt = $pdo->query("SELECT * FROM Behaviors WHERE Type = 'Good' AND IsActive = 1 ORDER BY Name");
                    $behaviors = $stmt->fetchAll();
                    echo json_encode($behaviors, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                } catch (Exception $e) {
                    error_log("Get Good Behaviors Error: " . $e->getMessage());
                    http_response_code(500);
                    echo json_encode(['error' => 'Database query failed: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                }
            } else {
                // Mock data - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡∏µ
                echo json_encode([
                    ['Id' => 'B001', 'Name' => '‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô', 'Points' => 10, 'Type' => 'Good', 'IsActive' => 1],
                    ['Id' => 'B002', 'Name' => '‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', 'Points' => 5, 'Type' => 'Good', 'IsActive' => 1]
                ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            }
            break;
            
        case 'bad-behaviors':
        case 'badbehaviors':
            // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏à‡∏≤‡∏Å database
            if ($dbConnection && $pdo) {
                try {
                    $stmt = $pdo->query("SELECT * FROM Behaviors WHERE Type = 'Bad' AND IsActive = 1 ORDER BY Name");
                    $behaviors = $stmt->fetchAll();
                    echo json_encode($behaviors, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                } catch (Exception $e) {
                    error_log("Get Bad Behaviors Error: " . $e->getMessage());
                    http_response_code(500);
                    echo json_encode(['error' => 'Database query failed: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                }
            } else {
                // Mock data - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏î‡∏µ
                echo json_encode([
                    ['Id' => 'B003', 'Name' => '‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏Å‡∏±‡∏ô', 'Points' => -5, 'Type' => 'Bad', 'IsActive' => 1]
                ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            }
            break;
            
        case 'rewards':
            // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å database
            if ($dbConnection && $pdo) {
                try {
                    $stmt = $pdo->query("SELECT * FROM Rewards WHERE IsActive = 1 ORDER BY Cost, Name");
                    $rewards = $stmt->fetchAll();
                    echo json_encode($rewards, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                } catch (Exception $e) {
                    error_log("Get Rewards Error: " . $e->getMessage());
                    http_response_code(500);
                    echo json_encode(['error' => 'Database query failed: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                }
            } else {
                // Mock data
                echo json_encode([
                    ['Id' => 'R001', 'Name' => '‡∏Ç‡∏ô‡∏°‡πÇ‡∏õ‡∏£‡∏î', 'Cost' => 10, 'IsActive' => 1],
                    ['Id' => 'R002', 'Name' => '‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ', 'Cost' => 15, 'IsActive' => 1],
                    ['Id' => 'R003', 'Name' => '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà', 'Cost' => 50, 'IsActive' => 1]
                ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            }
            break;
            
        case 'activities':
            if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IsRepeatable
                $input = json_decode(file_get_contents('php://input'), true);
                
                if (!$input || empty($input['ChildId']) || empty($input['ItemId'])) {
                    http_response_code(400);
                    echo json_encode(['error' => 'Missing ChildId or ItemId'], JSON_UNESCAPED_UNICODE);
                    exit();
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ActivityType
                $allowedTypes = ['Good', 'Bad', 'Reward'];
                $activityType = $input['ActivityType'] ?? 'Good';
                
                if (!in_array($activityType, $allowedTypes)) {
                    http_response_code(400);
                    echo json_encode([
                        'error' => 'Invalid ActivityType', 
                        'allowed_types' => $allowedTypes,
                        'received' => $activityType
                    ], JSON_UNESCAPED_UNICODE);
                    exit();
                }
                
                if ($dbConnection && $pdo) {
                    try {
                        // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IsRepeatable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Behaviors ***
                        if ($activityType === 'Good' || $activityType === 'Bad') {
                            $checkStmt = $pdo->prepare("
                                SELECT b.IsRepeatable, COUNT(da.Id) as existing_count
                                FROM Behaviors b
                                LEFT JOIN DailyActivity da ON b.Id = da.ItemId 
                                    AND da.ChildId = ? 
                                    AND da.ActivityDate = ?
                                    AND da.ActivityType = ?
                                WHERE b.Id = ?
                                GROUP BY b.IsRepeatable
                            ");
                            
                            $checkStmt->execute([
                                $input['ChildId'],
                                $input['ActivityDate'] ?? date('Y-m-d'),
                                $activityType,
                                $input['ItemId']
                            ]);
                            
                            $behaviorInfo = $checkStmt->fetch();
                            
                            if ($behaviorInfo) {
                                $isRepeatable = $behaviorInfo['IsRepeatable'];
                                $existingCount = $behaviorInfo['existing_count'];
                                
                                // ‡∏ñ‡πâ‡∏≤ IsRepeatable = 0 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ reject
                                if ($isRepeatable == 0 && $existingCount > 0) {
                                    http_response_code(409); // Conflict
                                    echo json_encode([
                                        'error' => 'Behavior already completed today',
                                        'message' => '‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô',
                                        'behavior_id' => $input['ItemId'],
                                        'is_repeatable' => false,
                                        'existing_count' => $existingCount
                                    ], JSON_UNESCAPED_UNICODE);
                                    exit();
                                }
                            }
                        }
                        
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                        $count = $input['Count'] ?? 1;
                        $earnedPoints = calculateEarnedPoints($pdo, $input['ItemId'], $activityType, $count);
                        
                        // Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ unique constraint ‡πÅ‡∏•‡πâ‡∏ß)
                        $stmt = $pdo->prepare("
                            INSERT INTO DailyActivity 
                            (ChildId, ItemId, ActivityType, Count, EarnedPoints, Note, ActivityDate, CreatedAt, UpdatedAt) 
                            VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), NOW())
                        ");
                        
                        $result = $stmt->execute([
                            $input['ChildId'],
                            $input['ItemId'],
                            $activityType,
                            $count,
                            $earnedPoints,
                            $input['Note'] ?? '',
                            $input['ActivityDate'] ?? date('Y-m-d')
                        ]);
                        
                        if ($result) {
                            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            $insertId = $pdo->lastInsertId();
                            $stmt = $pdo->prepare("
                                SELECT da.*, c.Name as ChildName,
                                       CASE 
                                           WHEN b.Name IS NOT NULL THEN b.Name
                                           WHEN r.Name IS NOT NULL THEN r.Name
                                           ELSE da.ItemId
                                       END as ItemName,
                                       CASE 
                                           WHEN b.Points IS NOT NULL THEN b.Points
                                           WHEN r.Cost IS NOT NULL THEN r.Cost
                                           ELSE 0
                                       END as ItemPoints,
                                       CASE
                                           WHEN b.IsRepeatable IS NOT NULL THEN b.IsRepeatable
                                           ELSE 1
                                       END as IsRepeatable
                                FROM DailyActivity da
                                LEFT JOIN Children c ON da.ChildId = c.Id
                                LEFT JOIN Behaviors b ON da.ItemId = b.Id
                                LEFT JOIN Rewards r ON da.ItemId = r.Id
                                WHERE da.Id = ?
                            ");
                            $stmt->execute([$insertId]);
                            $savedActivity = $stmt->fetch();
                            
                            echo json_encode([
                                'success' => true,
                                'message' => 'Activity recorded successfully',
                                'activity_id' => $insertId,
                                'earned_points' => $earnedPoints,
                                'is_repeatable' => $savedActivity['IsRepeatable'] ?? 1,
                                'data' => $savedActivity
                            ], JSON_UNESCAPED_UNICODE);
                        } else {
                            http_response_code(500);
                            echo json_encode(['error' => 'Failed to record activity'], JSON_UNESCAPED_UNICODE);
                        }
                    } catch (Exception $e) {
                        error_log("Record Activity Error: " . $e->getMessage());
                        http_response_code(500);
                        echo json_encode(['error' => 'Database error: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                    }
                } else {
                    http_response_code(503);
                    echo json_encode([
                        'error' => 'Database not connected',
                        'db_error' => $dbError
                    ], JSON_UNESCAPED_UNICODE);
                }
            }
            // ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á activities GET...
            break;
            
        case 'dashboard':
            if ($dbConnection && $pdo) {
                try {
                    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å database - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å EarnedPoints
                    $stmt = $pdo->query("
                        SELECT c.Id, c.Name, c.Age, c.AvatarPath,
                               COALESCE(SUM(CASE 
                                   WHEN da.ActivityDate = CURDATE() THEN da.EarnedPoints
                                   ELSE 0 
                               END), 0) as TodayPoints,
                               COALESCE(SUM(da.EarnedPoints), 0) as TotalPoints
                        FROM Children c
                        LEFT JOIN DailyActivity da ON c.Id = da.ChildId
                        WHERE c.IsActive = 1
                        GROUP BY c.Id, c.Name, c.Age, c.AvatarPath
                        ORDER BY c.Name
                    ");
                    $children = $stmt->fetchAll();
                    
                    echo json_encode([
                        'children' => $children,
                        'timestamp' => date('c'),
                        'total_children' => count($children),
                        'date' => date('Y-m-d'),
                        'database' => 'connected',
                        'version' => '3.2.0-complete'
                    ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                } catch (Exception $e) {
                    error_log("Dashboard Error: " . $e->getMessage());
                    // Fallback data with error
                    echo json_encode([
                        'children' => [
                            ['Id' => 'C001', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö1', 'TodayPoints' => 15, 'TotalPoints' => 45],
                            ['Id' => 'C002', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö2', 'TodayPoints' => 8, 'TotalPoints' => 32]
                        ],
                        'timestamp' => date('c'),
                        'total_children' => 2,
                        'date' => date('Y-m-d'),
                        'database' => 'error',
                        'error' => $e->getMessage()
                    ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                }
            } else {
                // Mock data
                echo json_encode([
                    'children' => [
                        ['Id' => 'C001', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö1', 'TodayPoints' => 15, 'TotalPoints' => 45],
                        ['Id' => 'C002', 'Name' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö2', 'TodayPoints' => 8, 'TotalPoints' => 32]
                    ],
                    'timestamp' => date('c'),
                    'total_children' => 2,
                    'date' => date('Y-m-d'),
                    'database' => 'disconnected',
                    'db_error' => $dbError
                ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            }
            break;
            
        default:
            echo json_encode([
                'message' => 'MyKids API v3.2.0 - Complete Database Integration',
                'status' => 'OK',
                'endpoints' => [
                    '?health - Health check and database status',
                    '?children - Children data (GET/POST)',
                    '?behaviors - All behaviors data',
                    '?good-behaviors - Good behaviors only', 
                    '?bad-behaviors - Bad behaviors only',
                    '?rewards - Rewards data',
                    '?activities - Activities data (GET/POST) - Complete Integration',
                    '?dashboard - Dashboard summary with real calculated points'
                ],
                'activity_types' => ['Good', 'Bad', 'Reward'],
                'features' => [
                    'Complete DailyActivity table integration',
                    'Automatic EarnedPoints calculation',
                    'Proper enum ActivityType handling',
                    'Full database schema support',
                    'Enhanced error handling'
                ],
                'debug_info' => [
                    'request_method' => $_SERVER['REQUEST_METHOD'],
                    'endpoint' => $endpoint,
                    'config_exists' => file_exists('config.php'),
                    'db_connection' => $dbConnection,
                    'db_error' => $dbError,
                    'php_version' => PHP_VERSION,
                    'current_time' => date('Y-m-d H:i:s')
                ]
            ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
            break;
    }

} catch (Exception $e) {
    error_log("API Error: " . $e->getMessage());
    http_response_code(500);
    echo json_encode([
        'error' => 'Server error',
        'message' => $e->getMessage(),
        'debug' => [
            'file' => basename(__FILE__),
            'line' => $e->getLine(),
            'time' => date('Y-m-d H:i:s'),
            'trace' => $e->getTraceAsString()
        ]
    ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
}
?>