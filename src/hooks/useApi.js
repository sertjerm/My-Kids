// src/hooks/useApi.js
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏û‡∏¥‡πà‡∏° Mutation Hooks ‡πÅ‡∏•‡∏∞ Activity Recording Hooks

import { useState, useEffect, useCallback } from "react";
import api from "../services/api";

// Custom hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö localStorage
export const useLocalStorageState = (key, defaultValue) => {
  const [state, setState] = useState(() => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (error) {
      console.warn(`Error reading localStorage key "${key}":`, error);
      return defaultValue;
    }
  });

  const setValue = useCallback((value) => {
    try {
      setState(value);
      localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.warn(`Error setting localStorage key "${key}":`, error);
    }
  }, [key]);

  return [state, setValue];
};

// Base API hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GET requests
export const useApi = (apiFunction, dependencies = []) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const result = await apiFunction();
      setData(result);
    } catch (err) {
      console.error("API Error:", err);
      setError(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    } finally {
      setLoading(false);
    }
  }, [apiFunction]);

  useEffect(() => {
    fetchData();
  }, dependencies);

  const refetch = useCallback(() => {
    fetchData();
  }, [fetchData]);

  return { data, loading, error, refetch };
};

// *** Hook ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö POST/PUT/DELETE requests ***
export const useApiMutation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const mutate = useCallback(async (apiFunction, data) => {
    try {
      setLoading(true);
      setError(null);

      console.log("üöÄ Mutation starting:", { apiFunction: apiFunction.name, data });
      
      // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
      if (data) {
        api.utils.debugActivity && api.utils.debugActivity(data);
      }

      const result = await apiFunction(data);
      
      console.log("‚úÖ Mutation success:", result);
      
      return result;
    } catch (err) {
      console.error("‚ùå Mutation error:", err);
      setError(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      throw err; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ component ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
    } finally {
      setLoading(false);
    }
  }, []);

  const reset = useCallback(() => {
    setError(null);
  }, []);

  return { mutate, loading, error, reset };
};

// API Status hook
export const useApiStatus = () => {
  const [status, setStatus] = useState("checking");
  const [statusData, setStatusData] = useState(null);

  const checkStatus = useCallback(async () => {
    try {
      setStatus("checking");
      const result = await api.utils.checkStatus();
      setStatus(result.status);
      setStatusData(result.data);
    } catch (error) {
      setStatus("error");
      setStatusData({ error: error.message });
    }
  }, []);

  useEffect(() => {
    checkStatus();
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    const interval = setInterval(checkStatus, 30000);
    return () => clearInterval(interval);
  }, [checkStatus]);

  return {
    status,
    statusData,
    checkStatus,
    isConnected: status === "connected",
    isError: status === "error",
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
export const useChildren = () => {
  const { data, loading, error, refetch } = useApi(api.children.getAll);
  
  const transformedData = data ? data.map(api.utils.transformChild) : [];
  
  return { 
    children: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dashboard
export const useDashboard = () => {
  const { data, loading, error, refetch } = useApi(api.dashboard.getSummary);
  
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dashboard
  const transformedData = data ? {
    children: data.children ? data.children.map(api.utils.transformChild) : [],
    totalChildren: data.total_children || 0,
    date: data.date,
    database: data.database
  } : null;
  
  return { 
    dashboardData: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡∏µ
export const useGoodBehaviors = () => {
  const { data, loading, error, refetch } = useApi(api.behaviors.getGood);
  
  const transformedData = data ? data.map(api.utils.transformBehavior) : [];
  
  return { 
    goodBehaviors: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏î‡∏µ
export const useBadBehaviors = () => {
  const { data, loading, error, refetch } = useApi(api.behaviors.getBad);
  
  const transformedData = data ? data.map(api.utils.transformBehavior) : [];
  
  return { 
    badBehaviors: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
export const useRewards = () => {
  const { data, loading, error, refetch } = useApi(api.rewards.getAll);
  
  const transformedData = data ? data.map(api.utils.transformReward) : [];
  
  return { 
    rewards: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
export const useActivities = () => {
  const { data, loading, error, refetch } = useApi(api.activities.getAll);
  
  const transformedData = data ? data.map(api.utils.transformActivity) : [];
  
  return { 
    activities: transformedData, 
    loading, 
    error, 
    refetch 
  };
};

// *** Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà ***
export const useCreateChild = () => {
  const { mutate, loading, error, reset } = useApiMutation();

  const createChild = useCallback(async (childData) => {
    return await mutate(api.children.create, childData);
  }, [mutate]);

  return { createChild, loading, error, reset };
};

// *** Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà ***
export const useCreateActivity = () => {
  const { mutate, loading, error, reset } = useApiMutation();

  const createActivity = useCallback(async (activityData) => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!activityData.childId) {
      throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ childId");
    }
    if (!activityData.itemId) {
      throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ itemId");
    }
    if (!activityData.activityType) {
      throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ activityType");
    }

    console.log("üéØ Creating activity with data:", activityData);
    
    return await mutate(api.activities.create, activityData);
  }, [mutate]);

  return { createActivity, loading, error, reset };
};

// *** Hook ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ***
export const useRecordBehavior = () => {
  const { createActivity, loading, error, reset } = useCreateActivity();

  const recordBehavior = useCallback(async (childId, behavior, count = 1, note = "") => {
    if (!childId || !behavior) {
      throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ childId ‡πÅ‡∏•‡∏∞ behavior");
    }

    const activityData = api.utils.createActivityFromBehavior(childId, behavior, count, note);
    
    console.log("üìù Recording behavior:", { childId, behavior: behavior.name, count, note });
    
    return await createActivity(activityData);
  }, [createActivity]);

  return { recordBehavior, loading, error, reset };
};

// *** Hook ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ***
export const useRecordReward = () => {
  const { createActivity, loading, error, reset } = useCreateActivity();

  const recordReward = useCallback(async (childId, reward, count = 1, note = "") => {
    if (!childId || !reward) {
      throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ childId ‡πÅ‡∏•‡∏∞ reward");
    }

    const activityData = api.utils.createActivityFromReward(childId, reward, count, note);
    
    console.log("üéÅ Recording reward:", { childId, reward: reward.name, count, note });
    
    return await createActivity(activityData);
  }, [createActivity]);

  return { recordReward, loading, error, reset };
};

// *** Hook ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ***
export const useRecordMultipleActivities = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const recordMultiple = useCallback(async (activities) => {
    try {
      setLoading(true);
      setError(null);

      console.log("üìã Recording multiple activities:", activities.length);
      
      const results = await api.utils.recordMultipleActivities(activities);
      
      const successCount = results.filter(r => r.success).length;
      const failCount = results.filter(r => !r.success).length;
      
      console.log(`‚úÖ Multiple activities result: ${successCount} success, ${failCount} failed`);
      
      if (failCount > 0) {
        const errors = results.filter(r => !r.success).map(r => r.error).join(", ");
        throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${errors}`);
      }
      
      return results;
    } catch (err) {
      console.error("‚ùå Multiple activities error:", err);
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  const reset = useCallback(() => {
    setError(null);
  }, []);

  return { recordMultiple, loading, error, reset };
};

// Hook ‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ChildDashboard - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
export const useChildDashboardData = (childId = null) => {
  const { children, loading: childrenLoading, error: childrenError, refetch: refetchChildren } = useChildren();
  const { goodBehaviors, loading: goodLoading, error: goodError, refetch: refetchGood } = useGoodBehaviors();
  const { badBehaviors, loading: badLoading, error: badError, refetch: refetchBad } = useBadBehaviors();
  const { rewards, loading: rewardsLoading, error: rewardsError, refetch: refetchRewards } = useRewards();

  const [selectedChild, setSelectedChild] = useState(null);

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  useEffect(() => {
    if (children.length > 0 && !selectedChild) {
      const child = childId 
        ? children.find(c => c.id === childId) 
        : children[0];
      setSelectedChild(child);
    }
  }, [children, childId, selectedChild]);

  const loading = childrenLoading || goodLoading || badLoading || rewardsLoading;
  const error = childrenError || goodError || badError || rewardsError;

  const refetchAll = useCallback(() => {
    refetchChildren();
    refetchGood();
    refetchBad();
    refetchRewards();
  }, [refetchChildren, refetchGood, refetchBad, refetchRewards]);

  return {
    children,
    goodBehaviors,
    badBehaviors,
    rewards,
    selectedChild,
    setSelectedChild,
    loading,
    error,
    refetchAll,
  };
};

// *** Hook ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ***
export const useActivityRecorder = (onSuccess, onError) => {
  const { recordBehavior, loading: behaviorLoading, error: behaviorError, reset: resetBehavior } = useRecordBehavior();
  const { recordReward, loading: rewardLoading, error: rewardError, reset: resetReward } = useRecordReward();

  const [lastActivity, setLastActivity] = useState(null);

  const recordActivity = useCallback(async (childId, item, type, count = 1, note = "") => {
    try {
      let result;
      
      if (type === 'behavior') {
        result = await recordBehavior(childId, item, count, note);
      } else if (type === 'reward') {
        result = await recordReward(childId, item, count, note);
      } else {
        throw new Error("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }

      setLastActivity({ childId, item, type, count, note, result, timestamp: Date.now() });
      
      if (onSuccess) {
        onSuccess(result);
      }
      
      return result;
    } catch (error) {
      console.error("‚ùå Record activity failed:", error);
      
      if (onError) {
        onError(error);
      }
      
      throw error;
    }
  }, [recordBehavior, recordReward, onSuccess, onError]);

  const reset = useCallback(() => {
    resetBehavior();
    resetReward();
    setLastActivity(null);
  }, [resetBehavior, resetReward]);

  return {
    recordActivity,
    loading: behaviorLoading || rewardLoading,
    error: behaviorError || rewardError,
    lastActivity,
    reset,
  };
};